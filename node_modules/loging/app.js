const http = require('http');
const fs = require('fs');
const path = require('path');
const url = require('url');
const mime = require('mime');
let static = 'public';
http.createServer((req, res) => {
    let pathname = url.parse(req.url).pathname;
    res.setHeader('Content-type', mime.getType(path.join(static, pathname)));
    if (pathname === '/') {
        pathname = '/login.html';
    }
    if (path.extname(pathname)) {
        if (fs.existsSync(path.join(static, pathname))) {
            res.end(fs.readFileSync(path.join(static, pathname)));
        }
    } else {
        // if (req.method === 'GET' && pathname === '/api/list') {
        //     // GET请求
        //     let { username, password } = url.parse(req.url, true).query;
        //     if (username === 'name' && password === '123456') {
        //         res.end('1');
        //     } else {
        //         res.end('0');
        //     }
        // }
        if (req.method === 'POST' && pathname === '/api/list') {
            // POST请求
            let str = '';
            req.on('data', (chunk) => {
                str += chunk;
            })
            req.on('end', () => {
                let { username, password } = JSON.parse(str);
                let data = require('./public/user.json');
                let flag = data.some(item => item.username === username && item.password === password);
                if (flag) {
                    res.end(username);
                } else {
                    res.end('0');
                }
            })
        }
        if (req.method === 'POST' && pathname === '/api/register') {
            let data = JSON.parse(fs.readFileSync(path.join(static, 'user.json')));
            console.log(typeof data);
            let str = '';
            req.on('data', (chunk) => {
                str += chunk;
            })
            req.on('end', () => {
                let { username } = JSON.parse(str);
                let data = require('./public/user.json');
                let flag = data.some(item => item.username === username);
                if (flag) {
                    res.end('0');
                } else {
                    data.push(JSON.parse(str));
                    fs.writeFileSync('public/user.json', JSON.stringify(data));
                    res.end('1');
                }
            })
        }
    }
}).listen(8080, () => {
    console.log('http://localhost:8080')
})